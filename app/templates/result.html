{% extends "base.html" %}
{% block content %}
<h1>{{ t.result_title }}</h1>
<p>{{ t.result_file }}<code>{{ display_filename }}</code></p>
<p>{{ t.result_job_id }}<code>{{ job_id }}</code></p>

<div class="downloads">
  <a class="download" href="{{ csv_url }}">{{ t.result_download_results }}</a>
  <a class="download" href="{{ pdf_url }}">{{ t.result_download_annotated }}</a>
  {% if analysis_report_url %}
    <a class="download" href="{{ analysis_report_url }}">{{ t.result_download_analysis_pdf }}</a>
  {% endif %}
  {% if showwrong_url %}
    <a class="download" href="{{ showwrong_url }}">{{ t.result_download_showwrong }}</a>
  {% endif %}
  <button class="download" type="button" id="printBtn" title="{{ t.result_print_pdf_hint }}">{{ t.result_print_pdf }}</button>
</div>

{% if analysis_error %}
  <p class="hint" style="color:#fca5a5">{{ analysis_error }}</p>
{% endif %}
{% if analysis_message %}
  <p class="hint">{{ analysis_message }}</p>
{% endif %}
{% if analysis_discrimination_note_key %}
  <p class="hint">{{ t[analysis_discrimination_note_key] }}</p>
{% endif %}

{% if analysis_score_hist_inline_url or analysis_item_plot_inline_url %}
  <h2>{{ t.result_plots_title }}</h2>
  <div class="plots">
    {% if analysis_score_hist_inline_url %}
      <div class="plot-card">
        <p class="hint">{{ t.result_plot_score_hist }}</p>
        <img class="plot" src="{{ analysis_score_hist_inline_url }}" alt="{{ t.result_plot_score_hist }}" loading="eager" />
      </div>
    {% endif %}
    {% if analysis_item_plot_inline_url %}
      <div class="plot-card">
        <p class="hint">{{ t.result_plot_item_metrics }}</p>
        <img class="plot" src="{{ analysis_item_plot_inline_url }}" alt="{{ t.result_plot_item_metrics }}" loading="eager" />
      </div>
    {% endif %}
  </div>
{% endif %}

{% if analysis_files %}
  <h2>{{ t.result_analysis_files_title }}</h2>
  <p class="hint">{{ t.result_analysis_files_hint }}</p>
  <div class="downloads">
    {% for f in analysis_files %}
      <a class="download" href="{{ f.url }}" target="_blank" rel="noopener noreferrer">{{ f.label }}</a>
    {% endfor %}
  </div>
{% endif %}

<p class="hint">{{ t.result_hint_unstable }}</p>

<script>
  (() => {
    const btn = document.getElementById("printBtn");
    if (!btn) return;
    const waitForImages = (timeoutMs = 2500) => {
      try {
        const imgs = Array.from(document.images || []);
        const pending = imgs.filter((img) => !img.complete);
        if (!pending.length) return Promise.resolve();
        return new Promise((resolve) => {
          let done = false;
          const timer = window.setTimeout(() => {
            if (done) return;
            done = true;
            resolve();
          }, timeoutMs);
          let remaining = pending.length;
          const onDone = () => {
            remaining -= 1;
            if (remaining > 0 || done) return;
            done = true;
            window.clearTimeout(timer);
            resolve();
          };
          pending.forEach((img) => {
            img.addEventListener("load", onDone, { once: true });
            img.addEventListener("error", onDone, { once: true });
          });
        });
      } catch (_) {
        return Promise.resolve();
      }
    };
    btn.addEventListener("click", async () => {
      await waitForImages();
      window.print();
    });
  })();
</script>
{% endblock %}
