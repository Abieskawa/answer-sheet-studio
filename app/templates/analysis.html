{% extends "base.html" %}
{% block content %}
<h1>{{ t.analysis_title }}</h1>
<p class="hint">{{ t.analysis_hint }}</p>

{% if job_id %}
  <p>{{ t.analysis_job_id }}<code>{{ job_id }}</code></p>

  <form class="form" action="/analysis/template" method="get">
    <input type="hidden" name="job_id" value="{{ job_id }}" />
    <label>{{ t.analysis_label_default_points }}
      <input type="number" name="points" min="0" max="100" value="{{ default_points|default(1) }}" />
    </label>
    <button type="submit">{{ t.analysis_btn_download_template }}</button>
    <p class="hint">{{ t.analysis_hint_template }}</p>
  </form>
{% endif %}

{% if error %}
  <p class="hint" style="color:#fca5a5">{{ error }}</p>
{% endif %}
{% if message %}
  <p class="hint">{{ message }}</p>
{% endif %}

<form class="form" action="/api/analysis/run" method="post" enctype="multipart/form-data">
  {% if job_id %}
    <input type="hidden" name="job_id" value="{{ job_id }}" />
  {% else %}
    <label>{{ t.analysis_label_job_id }}
      <input type="text" name="job_id" placeholder="{{ t.analysis_ph_job_id }}" required />
    </label>
  {% endif %}

  <label>{{ t.analysis_label_template_file }}
    <input type="file" name="analysis_csv" accept=".csv,text/csv" required />
  </label>
  <button type="submit">{{ t.analysis_btn_run }}</button>
  <p class="hint">{{ t.analysis_hint_upload }}</p>
</form>

{% if files %}
  <div class="downloads">
    {% for f in files %}
      <a class="download" href="{{ f.url }}">{{ f.label }}</a>
    {% endfor %}
  </div>
{% endif %}

<script>
  (() => {
    const key = "answer_sheet_studio_analysis_points";
    const input = document.querySelector('input[name="points"]');
    if (!input) return;
    const saved = localStorage.getItem(key);
    if (saved && /^[0-9]+$/.test(saved)) input.value = saved;
    input.addEventListener("input", () => localStorage.setItem(key, input.value));
  })();
</script>
{% endblock %}

