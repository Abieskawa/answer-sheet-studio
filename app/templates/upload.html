{% extends "base.html" %}
{% block content %}
<h1>{{ t.upload_title }}</h1>
<form class="form" action="/api/process" method="post" enctype="multipart/form-data">
  <label>{{ t.upload_label_num_questions }}
    <input type="number" name="num_questions" min="1" max="100" placeholder="{{ t.upload_ph_num_questions }}" required />
  </label>

  <label>{{ t.upload_label_choices_count }}
    <select name="choices_count">
      <option value="3">ABC</option>
      <option value="4" selected>ABCD</option>
      <option value="5">ABCDE</option>
    </select>
  </label>

  <label>{{ t.upload_label_pdf }}
    <input type="file" name="pdf" accept="application/pdf" required />
  </label>

  <label>{{ t.upload_label_answer_key }}
    <input type="file" name="answer_key" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required />
  </label>

  <button type="submit">{{ t.upload_btn_process }}</button>
  <div id="processing" class="hint" style="display:none">
    <progress style="width:260px"></progress>
    <span>{{ t.upload_processing }}</span>
  </div>

  <p class="hint">{{ t.upload_hint_output }}</p>
</form>

{% if job_id %}
  <hr />
  <h2>{{ t.result_title }}</h2>
  <p>{{ t.result_file }}<code>{{ display_filename }}</code></p>
  <p>{{ t.result_job_id }}<code>{{ job_id }}</code></p>

  <div class="downloads">
    <a class="download" href="{{ csv_url }}">{{ t.result_download_results }}</a>
    <a class="download" href="{{ pdf_url }}">{{ t.result_download_annotated }}</a>
    {% if answer_key_url %}
      <a class="download" href="{{ answer_key_url }}">{{ t.result_download_answer_key }}</a>
    {% endif %}
  </div>

  {% if analysis_error %}
    <p class="hint" style="color:#fca5a5">{{ analysis_error }}</p>
  {% endif %}
  {% if analysis_message %}
    <p class="hint">{{ analysis_message }}</p>
  {% endif %}

  {% if analysis_files %}
    <div class="downloads">
      {% for f in analysis_files %}
        <a class="download" href="{{ f.url }}">{{ f.label }}</a>
      {% endfor %}
    </div>
  {% endif %}

  <p class="hint">{{ t.result_hint_unstable }}</p>
{% endif %}

<script>
  (() => {
    const key = "answer_sheet_studio_choices_count";
    const select = document.querySelector('select[name="choices_count"]');
    if (!select) return;
    const saved = localStorage.getItem(key);
    if (saved && /^(3|4|5)$/.test(saved)) select.value = saved;
    select.addEventListener("change", () => localStorage.setItem(key, select.value));
  })();

  (() => {
    const form = document.querySelector("form.form");
    const processing = document.getElementById("processing");
    const btn = form ? form.querySelector('button[type="submit"]') : null;
    if (!form || !processing || !btn) return;
    let pollTimer = null;
    let resultWindow = null;

    const resetUi = () => {
      btn.disabled = false;
      processing.style.display = "none";
      if (pollTimer) {
        window.clearInterval(pollTimer);
        pollTimer = null;
      }
      resultWindow = null;
    };

    form.addEventListener("submit", () => {
      const target = `answer_sheet_result_${Date.now()}`;
      try {
        resultWindow = window.open("about:blank", target);
      } catch (_) {
        resultWindow = null;
      }
      form.target = resultWindow ? target : "_self";

      btn.disabled = true;
      processing.style.display = "block";

      if (!resultWindow) return;
      pollTimer = window.setInterval(() => {
        if (!resultWindow || resultWindow.closed) {
          resetUi();
          return;
        }
        try {
          const path = resultWindow.location.pathname || "";
          if (path.startsWith("/result/")) resetUi();
        } catch (_) {
          // ignore cross-origin/transient access during navigation
        }
      }, 500);
    });
  })();
</script>
{% endblock %}
